<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - test/controllers-admin.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>test/controllers-admin.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">73.02</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">959</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">61.47</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">12.84</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">&#039;use strict&#039;;

const async = require(&#039;async&#039;);
const assert = require(&#039;assert&#039;);
const nconf = require(&#039;nconf&#039;);
const request = require(&#039;request&#039;);

const db = require(&#039;./mocks/databasemock&#039;);
const categories = require(&#039;../src/categories&#039;);
const topics = require(&#039;../src/topics&#039;);
const user = require(&#039;../src/user&#039;);
const groups = require(&#039;../src/groups&#039;);
const helpers = require(&#039;./helpers&#039;);
const meta = require(&#039;../src/meta&#039;);

describe(&#039;Admin Controllers&#039;, () =&gt; {
    let tid;
    let cid;
    let pid;
    let regularPid;
    let adminUid;
    let regularUid;
    let regular2Uid;
    let moderatorUid;
    let jar;

    before((done) =&gt; {
        async.series({
            category: function (next) {
                categories.create({
                    name: &#039;Test Category&#039;,
                    description: &#039;Test category created by testing script&#039;,
                }, next);
            },
            adminUid: function (next) {
                user.create({ username: &#039;admin&#039;, password: &#039;barbar&#039; }, next);
            },
            regularUid: function (next) {
                user.create({ username: &#039;regular&#039;, password: &#039;regularpwd&#039; }, next);
            },
            regular2Uid: function (next) {
                user.create({ username: &#039;regular2&#039; }, next);
            },
            moderatorUid: function (next) {
                user.create({ username: &#039;moderator&#039;, password: &#039;modmod&#039; }, next);
            },
        }, async (err, results) =&gt; {
            if (err) {
                return done(err);
            }
            adminUid = results.adminUid;
            regularUid = results.regularUid;
            regular2Uid = results.regular2Uid;
            moderatorUid = results.moderatorUid;
            cid = results.category.cid;

            const adminPost = await topics.post({ uid: adminUid, title: &#039;test topic title&#039;, content: &#039;test topic content&#039;, cid: results.category.cid });
            assert.ifError(err);
            tid = adminPost.topicData.tid;
            pid = adminPost.postData.pid;

            const regularPost = await topics.post({ uid: regular2Uid, title: &#039;regular user\&#039;s test topic title&#039;, content: &#039;test topic content&#039;, cid: results.category.cid });
            regularPid = regularPost.postData.pid;
            done();
        });
    });

    it(&#039;should 403 if user is not admin&#039;, (done) =&gt; {
        helpers.loginUser(&#039;admin&#039;, &#039;barbar&#039;, (err, data) =&gt; {
            assert.ifError(err);
            jar = data.jar;
            request(`${nconf.get(&#039;url&#039;)}/admin`, { jar: jar }, (err, res, body) =&gt; {
                assert.ifError(err);
                assert.equal(res.statusCode, 403);
                assert(body);
                done();
            });
        });
    });

    it(&#039;should load admin dashboard&#039;, (done) =&gt; {
        groups.join(&#039;administrators&#039;, adminUid, (err) =&gt; {
            assert.ifError(err);
            const dashboards = [
                &#039;/admin&#039;, &#039;/admin/dashboard/logins&#039;, &#039;/admin/dashboard/users&#039;, &#039;/admin/dashboard/topics&#039;, &#039;/admin/dashboard/searches&#039;,
            ];
            async.each(dashboards, (url, next) =&gt; {
                request(`${nconf.get(&#039;url&#039;)}${url}`, { jar: jar }, (err, res, body) =&gt; {
                    assert.ifError(err);
                    assert.equal(res.statusCode, 200, url);
                    assert(body);

                    next();
                });
            }, done);
        });
    });

    it(&#039;should load admin analytics&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/analytics?units=hours`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            assert(body.query);
            assert(body.result);
            done();
        });
    });

    it(&#039;should load groups page&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/admin/manage/groups`, { jar: jar }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load groups detail page&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/admin/manage/groups/administrators`, { jar: jar }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load global privileges page&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/admin/manage/privileges`, { jar: jar }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load admin privileges page&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/admin/manage/privileges/admin`, { jar: jar }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load privileges page for category 1&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/admin/manage/privileges/1`, { jar: jar }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load manage digests&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/admin/manage/digest`, { jar: jar }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load manage uploads&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/admin/manage/uploads`, { jar: jar }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load general settings page&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/admin/settings`, { jar: jar }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load email settings page&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/admin/settings/email`, { jar: jar }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load user settings page&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/admin/settings/user`, { jar: jar }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load info page for a user&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/user/regular/info`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body.history);
            assert(Array.isArray(body.history.flags));
            assert(Array.isArray(body.history.bans));
            assert(Array.isArray(body.sessions));
            done();
        });
    });

    it(&#039;should 404 for edit/email page if user does not exist&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/user/doesnotexist/edit/email`, { jar: jar, json: true }, (err, res) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 404);
            done();
        });
    });

    it(&#039;should load /admin/settings/homepage&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/settings/homepage`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body.routes);
            done();
        });
    });

    it(&#039;should load /admin/advanced/database&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/advanced/database`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);

            if (nconf.get(&#039;redis&#039;)) {
                assert(body.redis);
            } else if (nconf.get(&#039;mongo&#039;)) {
                assert(body.mongo);
            } else if (nconf.get(&#039;postgres&#039;)) {
                assert(body.postgres);
            }
            done();
        });
    });

    it(&#039;should load /admin/extend/plugins&#039;, function (done) {
        this.timeout(50000);
        request(`${nconf.get(&#039;url&#039;)}/api/admin/extend/plugins`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert(body.hasOwnProperty(&#039;installed&#039;));
            assert(body.hasOwnProperty(&#039;upgradeCount&#039;));
            assert(body.hasOwnProperty(&#039;download&#039;));
            assert(body.hasOwnProperty(&#039;incompatible&#039;));
            done();
        });
    });

    it(&#039;should load /admin/manage/users&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/manage/users`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.strictEqual(res.statusCode, 200);
            assert(body);
            assert(body.users.length &gt; 0);
            done();
        });
    });


    it(&#039;should load /admin/manage/users?filters=banned&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/manage/users?filters=banned`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.strictEqual(res.statusCode, 200);
            assert(body);
            assert.strictEqual(body.users.length, 0);
            done();
        });
    });

    it(&#039;should load /admin/manage/users?filters=banned&amp;filters=verified&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/manage/users?filters=banned&amp;filters=verified`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.strictEqual(res.statusCode, 200);
            assert(body);
            assert.strictEqual(body.users.length, 0);
            done();
        });
    });

    it(&#039;should load /admin/manage/users?query=admin&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/manage/users?query=admin`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.strictEqual(res.statusCode, 200);
            assert(body);
            assert.strictEqual(body.users[0].username, &#039;admin&#039;);
            done();
        });
    });

    it(&#039;should return empty results if query is too short&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/manage/users?query=a`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.strictEqual(res.statusCode, 200);
            assert(body);
            assert.strictEqual(body.users.length, 0);
            done();
        });
    });

    it(&#039;should load /admin/manage/registration&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/manage/registration`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should 404 if users is not privileged&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/registration-queue`, { json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 404);
            assert(body);
            done();
        });
    });

    it(&#039;should load /api/registration-queue&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/registration-queue`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load /admin/manage/admins-mods&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/manage/admins-mods`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load /admin/users/csv&#039;, (done) =&gt; {
        const socketAdmin = require(&#039;../src/socket.io/admin&#039;);
        socketAdmin.user.exportUsersCSV({ uid: adminUid }, {}, (err) =&gt; {
            assert.ifError(err);
            setTimeout(() =&gt; {
                request(`${nconf.get(&#039;url&#039;)}/api/admin/users/csv`, {
                    jar: jar,
                    headers: {
                        referer: `${nconf.get(&#039;url&#039;)}/admin/manage/users`,
                    },
                }, (err, res, body) =&gt; {
                    assert.ifError(err);
                    assert.equal(res.statusCode, 200);
                    assert(body);
                    done();
                });
            }, 2000);
        });
    });

    it(&#039;should return 403 if no referer&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/groups/administrators/csv`, { jar: jar }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 403);
            assert.equal(body, &#039;[[error:invalid-origin]]&#039;);
            done();
        });
    });

    it(&#039;should return 403 if referer is not /api/admin/groups/administrators/csv&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/groups/administrators/csv`, {
            jar: jar,
            headers: {
                referer: &#039;/topic/1/test&#039;,
            },
        }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 403);
            assert.equal(body, &#039;[[error:invalid-origin]]&#039;);
            done();
        });
    });

    it(&#039;should load /api/admin/groups/administrators/csv&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/groups/administrators/csv`, {
            jar: jar,
            headers: {
                referer: `${nconf.get(&#039;url&#039;)}/admin/manage/groups`,
            },
        }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load /admin/advanced/hooks&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/advanced/hooks`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load /admin/advanced/cache&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/advanced/cache`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load /api/admin/advanced/cache/dump and 404 with no query param&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/advanced/cache/dump`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 404);
            assert(body);
            done();
        });
    });

    it(&#039;should load /api/admin/advanced/cache/dump&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/advanced/cache/dump?name=post`, { jar: jar }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load /admin/advanced/errors&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/advanced/errors`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load /admin/advanced/errors/export&#039;, (done) =&gt; {
        meta.errors.clear((err) =&gt; {
            assert.ifError(err);
            request(`${nconf.get(&#039;url&#039;)}/api/admin/advanced/errors/export`, { jar: jar }, (err, res, body) =&gt; {
                assert.ifError(err);
                assert.equal(res.statusCode, 200);
                assert.strictEqual(body, &#039;&#039;);
                done();
            });
        });
    });

    it(&#039;should load /admin/advanced/logs&#039;, (done) =&gt; {
        const fs = require(&#039;fs&#039;);
        fs.appendFile(meta.logs.path, &#039;dummy log&#039;, (err) =&gt; {
            assert.ifError(err);
            request(`${nconf.get(&#039;url&#039;)}/api/admin/advanced/logs`, { jar: jar, json: true }, (err, res, body) =&gt; {
                assert.ifError(err);
                assert.equal(res.statusCode, 200);
                assert(body);
                done();
            });
        });
    });

    it(&#039;should load /admin/settings/navigation&#039;, (done) =&gt; {
        const navigation = require(&#039;../src/navigation/admin&#039;);
        const data = require(&#039;../install/data/navigation.json&#039;);

        navigation.save(data, (err) =&gt; {
            assert.ifError(err);
            request(`${nconf.get(&#039;url&#039;)}/api/admin/settings/navigation`, { jar: jar, json: true }, (err, res, body) =&gt; {
                assert.ifError(err);
                assert(body);
                assert(body.available);
                assert(body.enabled);
                done();
            });
        });
    });

    it(&#039;should load /admin/development/info&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/development/info`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load /admin/development/logger&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/development/logger`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load /admin/advanced/events&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/advanced/events`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load /admin/manage/categories&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/manage/categories`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load /admin/manage/categories/1&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/manage/categories/1`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load /admin/manage/catgories?cid=&lt;cid&gt;&#039;, async () =&gt; {
        const { cid: rootCid } = await categories.create({ name: &#039;parent category&#039; });
        const { cid: childCid } = await categories.create({ name: &#039;child category&#039;, parentCid: rootCid });
        const { res, body } = await helpers.request(&#039;get&#039;, `/api/admin/manage/categories?cid=${rootCid}`, {
            jar: jar,
            json: true,
        });
        assert.strictEqual(res.statusCode, 200);
        assert.strictEqual(body.categoriesTree[0].cid, rootCid);
        assert.strictEqual(body.categoriesTree[0].children[0].cid, childCid);
        assert.strictEqual(body.breadcrumbs[0].text, &#039;[[admin/manage/categories:top-level]]&#039;);
        assert.strictEqual(body.breadcrumbs[1].text, &#039;parent category&#039;);
    });

    it(&#039;should load /admin/manage/categories/1/analytics&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/manage/categories/1/analytics`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load /admin/extend/rewards&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/extend/rewards`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load /admin/extend/widgets&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/extend/widgets`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load /admin/settings/languages&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/settings/languages`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load /admin/settings/social&#039;, (done) =&gt; {
        const socketAdmin = require(&#039;../src/socket.io/admin&#039;);
        socketAdmin.social.savePostSharingNetworks({ uid: adminUid }, [&#039;facebook&#039;, &#039;twitter&#039;], (err) =&gt; {
            assert.ifError(err);
            request(`${nconf.get(&#039;url&#039;)}/api/admin/settings/social`, { jar: jar, json: true }, (err, res, body) =&gt; {
                assert.ifError(err);
                assert(body);
                body = body.posts.map(network =&gt; network &amp;&amp; network.id);
                assert(body.includes(&#039;facebook&#039;));
                assert(body.includes(&#039;twitter&#039;));
                done();
            });
        });
    });

    it(&#039;should load /admin/manage/tags&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/manage/tags`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;/post-queue should 404 for regular user&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/post-queue`, { json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert(body);
            assert.equal(res.statusCode, 404);
            done();
        });
    });

    it(&#039;should load /post-queue&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/post-queue`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;/ip-blacklist should 404 for regular user&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/ip-blacklist`, { json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert(body);
            assert.equal(res.statusCode, 404);
            done();
        });
    });

    it(&#039;should load /ip-blacklist&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/ip-blacklist`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load /admin/appearance/themes&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/appearance/themes`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load /admin/appearance/customise&#039;, (done) =&gt; {
        request(`${nconf.get(&#039;url&#039;)}/api/admin/appearance/customise`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            done();
        });
    });

    it(&#039;should load /recent in maintenance mode&#039;, (done) =&gt; {
        meta.config.maintenanceMode = 1;
        request(`${nconf.get(&#039;url&#039;)}/api/recent`, { jar: jar, json: true }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            meta.config.maintenanceMode = 0;
            done();
        });
    });

    describe(&#039;mods page&#039;, () =&gt; {
        let moderatorJar;
        let regularJar;
        before(async () =&gt; {
            moderatorJar = (await helpers.loginUser(&#039;moderator&#039;, &#039;modmod&#039;)).jar;
            regularJar = (await helpers.loginUser(&#039;regular&#039;, &#039;regularpwd&#039;)).jar;
            await groups.join(`cid:${cid}:privileges:moderate`, moderatorUid);
        });

        it(&#039;should error with no privileges&#039;, (done) =&gt; {
            request(`${nconf.get(&#039;url&#039;)}/api/flags`, { json: true }, (err, res, body) =&gt; {
                assert.ifError(err);
                assert.deepStrictEqual(body, {
                    status: {
                        code: &#039;not-authorised&#039;,
                        message: &#039;A valid login session was not found. Please log in and try again.&#039;,
                    },
                    response: {},
                });
                done();
            });
        });

        it(&#039;should load flags page data&#039;, (done) =&gt; {
            request(`${nconf.get(&#039;url&#039;)}/api/flags`, { jar: moderatorJar, json: true }, (err, res, body) =&gt; {
                assert.ifError(err);
                assert(body);
                assert(body.flags);
                assert(body.filters);
                assert.equal(body.filters.cid.indexOf(cid), -1);
                done();
            });
        });

        it(&#039;should return a 404 if flag does not exist&#039;, (done) =&gt; {
            request(`${nconf.get(&#039;url&#039;)}/api/flags/123123123`, {
                jar: moderatorJar,
                json: true,
                headers: {
                    Accept: &#039;text/html, application/json&#039;,
                },
            }, (err, res, body) =&gt; {
                assert.ifError(err);
                assert.strictEqual(res.statusCode, 404);
                done();
            });
        });

        it(&#039;should error when you attempt to flag a privileged user\&#039;s post&#039;, async () =&gt; {
            const { res, body } = await helpers.request(&#039;post&#039;, &#039;/api/v3/flags&#039;, {
                json: true,
                jar: regularJar,
                form: {
                    id: pid,
                    type: &#039;post&#039;,
                    reason: &#039;spam&#039;,
                },
            });
            assert.strictEqual(res.statusCode, 400);
            assert.strictEqual(body.status.code, &#039;bad-request&#039;);
            assert.strictEqual(body.status.message, &#039;You are not allowed to flag the profiles or content of privileged users (moderators/global moderators/admins)&#039;);
        });

        it(&#039;should error with not enough reputation to flag&#039;, async () =&gt; {
            const oldValue = meta.config[&#039;min:rep:flag&#039;];
            meta.config[&#039;min:rep:flag&#039;] = 1000;
            const { res, body } = await helpers.request(&#039;post&#039;, &#039;/api/v3/flags&#039;, {
                json: true,
                jar: regularJar,
                form: {
                    id: regularPid,
                    type: &#039;post&#039;,
                    reason: &#039;spam&#039;,
                },
            });
            assert.strictEqual(res.statusCode, 400);
            assert.strictEqual(body.status.code, &#039;bad-request&#039;);
            assert.strictEqual(body.status.message, &#039;You need 1000 reputation to flag this post&#039;);

            meta.config[&#039;min:rep:flag&#039;] = oldValue;
        });

        it(&#039;should return flag details&#039;, async () =&gt; {
            const oldValue = meta.config[&#039;min:rep:flag&#039;];
            meta.config[&#039;min:rep:flag&#039;] = 0;
            const result = await helpers.request(&#039;post&#039;, &#039;/api/v3/flags&#039;, {
                json: true,
                jar: regularJar,
                form: {
                    id: regularPid,
                    type: &#039;post&#039;,
                    reason: &#039;spam&#039;,
                },
            });
            meta.config[&#039;min:rep:flag&#039;] = oldValue;

            const flagsResult = await helpers.request(&#039;get&#039;, `/api/flags`, {
                json: true,
                jar: moderatorJar,
            });

            assert(flagsResult.body);
            assert(Array.isArray(flagsResult.body.flags));
            const { flagId } = flagsResult.body.flags[0];

            const { body } = await helpers.request(&#039;get&#039;, `/api/flags/${flagId}`, {
                json: true,
                jar: moderatorJar,
            });
            assert(body.reports);
            assert(Array.isArray(body.reports));
            assert.strictEqual(body.reports[0].reporter.username, &#039;regular&#039;);
        });
    });

    it(&#039;should escape special characters in config&#039;, (done) =&gt; {
        const plugins = require(&#039;../src/plugins&#039;);
        function onConfigGet(config, callback) {
            config.someValue = &#039;&quot;foo&quot;&#039;;
            config.otherValue = &quot;&#039;123&#039;&quot;;
            config.script = &#039;&lt;/script&gt;&#039;;
            callback(null, config);
        }
        plugins.hooks.register(&#039;somePlugin&#039;, { hook: &#039;filter:config.get&#039;, method: onConfigGet });
        request(`${nconf.get(&#039;url&#039;)}/admin`, { jar: jar }, (err, res, body) =&gt; {
            assert.ifError(err);
            assert.equal(res.statusCode, 200);
            assert(body);
            assert(body.includes(&#039;&quot;someValue&quot;:&quot;\\\\&quot;foo\\\\&quot;&quot;&#039;));
            assert(body.includes(&#039;&quot;otherValue&quot;:&quot;\\\&#039;123\\\&#039;&quot;&#039;));
            assert(body.includes(&#039;&quot;script&quot;:&quot;&lt;\\/script&gt;&quot;&#039;));
            request(nconf.get(&#039;url&#039;), { jar: jar }, (err, res, body) =&gt; {
                assert.ifError(err);
                assert.equal(res.statusCode, 200);
                assert(body);
                assert(body.includes(&#039;&quot;someValue&quot;:&quot;\\\\&quot;foo\\\\&quot;&quot;&#039;));
                assert(body.includes(&#039;&quot;otherValue&quot;:&quot;\\\&#039;123\\\&#039;&quot;&#039;));
                assert(body.includes(&#039;&quot;script&quot;:&quot;&lt;\\/script&gt;&quot;&#039;));
                plugins.hooks.unregister(&#039;somePlugin&#039;, &#039;filter:config.get&#039;, onConfigGet);
                done();
            });
        });
    });

    describe(&#039;admin page privileges&#039;, () =&gt; {
        let userJar;
        let uid;
        const privileges = require(&#039;../src/privileges&#039;);
        before(async () =&gt; {
            uid = await user.create({ username: &#039;regularjoe&#039;, password: &#039;barbar&#039; });
            userJar = (await helpers.loginUser(&#039;regularjoe&#039;, &#039;barbar&#039;)).jar;
        });

        describe(&#039;routeMap parsing&#039;, () =&gt; {
            it(&#039;should allow normal user access to admin pages&#039;, async function () {
                this.timeout(50000);
                function makeRequest(url) {
                    return new Promise((resolve, reject) =&gt; {
                        request(url, { jar: userJar, json: true }, (err, res, body) =&gt; {
                            if (err) reject(err);
                            else resolve(res);
                        });
                    });
                }
                const uploadRoutes = [
                    &#039;category/uploadpicture&#039;,
                    &#039;uploadfavicon&#039;,
                    &#039;uploadTouchIcon&#039;,
                    &#039;uploadMaskableIcon&#039;,
                    &#039;uploadlogo&#039;,
                    &#039;uploadOgImage&#039;,
                    &#039;uploadDefaultAvatar&#039;,
                ];
                const adminRoutes = Object.keys(privileges.admin.routeMap)
                    .filter(route =&gt; !uploadRoutes.includes(route));
                for (const route of adminRoutes) {
                    /* eslint-disable no-await-in-loop */
                    await privileges.admin.rescind([privileges.admin.routeMap[route]], uid);
                    let res = await makeRequest(`${nconf.get(&#039;url&#039;)}/api/admin/${route}`);
                    assert.strictEqual(res.statusCode, 403);

                    await privileges.admin.give([privileges.admin.routeMap[route]], uid);
                    res = await makeRequest(`${nconf.get(&#039;url&#039;)}/api/admin/${route}`);
                    assert.strictEqual(res.statusCode, 200);

                    await privileges.admin.rescind([privileges.admin.routeMap[route]], uid);
                }

                for (const route of adminRoutes) {
                    /* eslint-disable no-await-in-loop */
                    await privileges.admin.rescind([privileges.admin.routeMap[route]], uid);
                    let res = await makeRequest(`${nconf.get(&#039;url&#039;)}/api/admin`);
                    assert.strictEqual(res.statusCode, 403);

                    await privileges.admin.give([privileges.admin.routeMap[route]], uid);
                    res = await makeRequest(`${nconf.get(&#039;url&#039;)}/api/admin`);
                    assert.strictEqual(res.statusCode, 200);

                    await privileges.admin.rescind([privileges.admin.routeMap[route]], uid);
                }
            });
        });

        describe(&#039;routePrefixMap parsing&#039;, () =&gt; {
            it(&#039;should allow normal user access to admin pages&#039;, async () =&gt; {
                // this.timeout(50000);
                function makeRequest(url) {
                    return new Promise((resolve, reject) =&gt; {
                        request(url, { jar: userJar, json: true }, (err, res, body) =&gt; {
                            if (err) reject(err);
                            else resolve(res);
                        });
                    });
                }
                for (const route of Object.keys(privileges.admin.routePrefixMap)) {
                    /* eslint-disable no-await-in-loop */
                    await privileges.admin.rescind([privileges.admin.routePrefixMap[route]], uid);
                    let res = await makeRequest(`${nconf.get(&#039;url&#039;)}/api/admin/${route}foobar/derp`);
                    assert.strictEqual(res.statusCode, 403);

                    await privileges.admin.give([privileges.admin.routePrefixMap[route]], uid);
                    res = await makeRequest(`${nconf.get(&#039;url&#039;)}/api/admin/${route}foobar/derp`);
                    assert.strictEqual(res.statusCode, 404);

                    await privileges.admin.rescind([privileges.admin.routePrefixMap[route]], uid);
                }
            });
        });

        it(&#039;should list all admin privileges&#039;, async () =&gt; {
            const privs = await privileges.admin.getPrivilegeList();
            assert.deepStrictEqual(privs, [
                &#039;admin:dashboard&#039;,
                &#039;admin:categories&#039;,
                &#039;admin:privileges&#039;,
                &#039;admin:admins-mods&#039;,
                &#039;admin:users&#039;,
                &#039;admin:groups&#039;,
                &#039;admin:tags&#039;,
                &#039;admin:settings&#039;,
                &#039;groups:admin:dashboard&#039;,
                &#039;groups:admin:categories&#039;,
                &#039;groups:admin:privileges&#039;,
                &#039;groups:admin:admins-mods&#039;,
                &#039;groups:admin:users&#039;,
                &#039;groups:admin:groups&#039;,
                &#039;groups:admin:tags&#039;,
                &#039;groups:admin:settings&#039;,
            ]);
        });
        it(&#039;should list user admin privileges&#039;, async () =&gt; {
            const privs = await privileges.admin.userPrivileges(adminUid);
            assert.deepStrictEqual(privs, {
                &#039;admin:dashboard&#039;: false,
                &#039;admin:categories&#039;: false,
                &#039;admin:privileges&#039;: false,
                &#039;admin:admins-mods&#039;: false,
                &#039;admin:users&#039;: false,
                &#039;admin:groups&#039;: false,
                &#039;admin:tags&#039;: false,
                &#039;admin:settings&#039;: false,
            });
        });

        it(&#039;should check if group has admin group privilege&#039;, async () =&gt; {
            await groups.create({ name: &#039;some-special-group&#039;, private: 1, hidden: 1 });
            await privileges.admin.give([&#039;groups:admin:users&#039;, &#039;groups:admin:groups&#039;], &#039;some-special-group&#039;);
            const can = await privileges.admin.canGroup(&#039;admin:users&#039;, &#039;some-special-group&#039;);
            assert.strictEqual(can, true);
            const privs = await privileges.admin.groupPrivileges(&#039;some-special-group&#039;);
            assert.deepStrictEqual(privs, {
                &#039;groups:admin:dashboard&#039;: false,
                &#039;groups:admin:categories&#039;: false,
                &#039;groups:admin:privileges&#039;: false,
                &#039;groups:admin:admins-mods&#039;: false,
                &#039;groups:admin:users&#039;: true,
                &#039;groups:admin:groups&#039;: true,
                &#039;groups:admin:tags&#039;: false,
                &#039;groups:admin:settings&#039;: false,
            });
        });

        it(&#039;should not have admin:privileges&#039;, async () =&gt; {
            const res = await privileges.admin.list(regularUid);
            assert.strictEqual(res.keys.users.includes(&#039;admin:privileges&#039;), false);
            assert.strictEqual(res.keys.groups.includes(&#039;admin:privileges&#039;), false);
        });
    });
});</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ cyclomatic }} <br>
    Length : {{ halstead.length }} <br>
    Difficulty : {{ halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
